<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CSV ‚Üí GitHub Project</title>
<style>
body{font-family:Arial, sans-serif;max-width:640px;margin:auto;padding:2rem;}
label{display:block;margin-top:1rem;}
input,select,button{width:100%;padding:0.6rem;font-size:1rem;border:1px solid #ddd;border-radius:4px;}
select{cursor:pointer;}
button{background:#f8f9fa;color:#333;cursor:pointer;transition:background-color 0.2s;}
button:hover:not(:disabled){background:#e9ecef;}
button:disabled{background:#f8f9fa;color:#6c757d;cursor:not-allowed;}
button[type="button"]{margin-top:0.5rem;}
progress{width:100%;height:1rem;margin-top:0.5rem;}
#log{white-space:pre-wrap;background:#f8f9fa;padding:1rem;margin-top:1.5rem;max-height:340px;overflow:auto;border:1px solid #ddd;border-radius:4px;}
small{display:block;margin-top:0.25rem;font-size:0.85em;color:#555;}
h1{color:#333;margin-bottom:1.5rem;}
h2{color:#495057;margin-bottom:1rem;font-size:1.3rem;}

/* Tooltip */
.tooltip{position:relative;display:inline-block;cursor:help;margin-left:0.25rem;}
.tooltip .tooltiptext{visibility:hidden;width:270px;background:#333;color:#fff;text-align:left;padding:0.6rem;border-radius:6px;position:absolute;z-index:1;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .2s;}
.tooltip:hover .tooltiptext,.tooltip:focus .tooltiptext{visibility:visible;opacity:1;}
.tooltip .tooltiptext::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#333 transparent transparent transparent;}

/* Navigation */
.nav-tabs{display:flex;border-bottom:2px solid #ddd;margin:2rem 0 1.5rem 0;}
.nav-tab{padding:0.75rem 1.5rem;background:#f8f9fa;border:1px solid #ddd;border-bottom:none;cursor:pointer;margin-right:0.25rem;border-radius:6px 6px 0 0;transition:background-color 0.2s;}
.nav-tab.active{background:#fff;border-bottom:2px solid #fff;margin-bottom:-2px;font-weight:bold;color:#007bff;}
.nav-tab:hover{background:#e9ecef;}

/* Pages */
.page{display:none;}
.page.active{display:block;}

/* Task management */
.task-item{border:1px solid #ddd;padding:1rem;margin:0.5rem 0;border-radius:6px;background:#f8f9fa;}
.task-item.selected{background:#e3f2fd;border-color:#2196f3;}
.task-title{font-weight:bold;margin-bottom:0.5rem;}
.task-body{color:#666;font-size:0.9em;margin-bottom:0.5rem;}
.task-meta{font-size:0.8em;color:#888;}
.checkbox-container{display:flex;align-items:flex-start;gap:0.5rem;}
.bulk-actions{margin:1rem 0;padding:1rem;background:#fff3cd;border:1px solid #ffeaa7;border-radius:6px;}
.danger-btn{background:#dc3545;color:white;}
.danger-btn:hover{background:#c82333;}
</style>
</head>
<body>
<h1>GitHub Project Manager</h1>

<!-- Shared Token Field -->
<label>Personal Access Token (repo, project):
  <input id="token" type="password" required>
  <small>
    <a href="https://github.com/settings/tokens" target="_blank">Where do I get my token?</a>
    <span class="tooltip" tabindex="0">‚ÑπÔ∏è
      <span class="tooltiptext">
        <strong>How to create your token:</strong><br>
        1. Go to GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic)<br>
        2. Click "Generate new token"<br>
        3. Select these scopes:<br>
        &nbsp;&nbsp;‚Ä¢ <strong>repo</strong> - to create issues<br>
        &nbsp;&nbsp;‚Ä¢ <strong>project</strong> - to manage Projects V2<br>
        4. Copy the token and paste it here<br><br>
        <strong>Note:</strong> For public repos only, you can use <code>public_repo</code> instead of <code>repo</code>
      </span>
    </span>
  </small>
</label>

<!-- Navigation -->
<div class="nav-tabs">
  <div class="nav-tab active" onclick="showPage('import')">üì§ Import CSV</div>
  <div class="nav-tab" onclick="showPage('manage')">üìã Manage Tasks</div>
</div>

<!-- Page 1: Import CSV -->
<div id="page-import" class="page active">
  <h2>CSV ‚Üí GitHub Project</h2>

  <label>Owner/Org (empty = your token user):
  <input id="owner" type="text" placeholder="my_username_or_org"></label>

  <label>Projects V2 list:
    <select id="projectSelect" disabled>
      <option value="">-- Load the list --</option>
    </select>
    <button type="button" id="loadProjects" disabled>Enter token first</button>
  </label>

  <label>Repository to create issues in:
  <select id="repo" required disabled>
    <option value="">-- Load repository list --</option>
  </select>
  <button type="button" id="loadRepos" disabled>Enter token first</button>
  <small>Issues will be created in this repository and then added to the selected project. Projects V2 can contain issues from multiple repositories.</small>
  </label>

  <label>CSV file (title,body):
  <input id="file" type="file" accept=".csv" required>
  <small>
    <span class="tooltip" tabindex="0">üìã
      <span class="tooltiptext"><strong>CSV format:</strong><br><br>
      <strong>First row:</strong> header (ignored)<br>
      <strong>First column:</strong> Issue title<br>
      <strong>Second column:</strong> Description (optional)<br><br>
      <strong>Example:</strong><br>
      title,body<br>
      Setup project,Basic configuration<br>
      Add authentication,Login and register screens<br>
      Database design,"Users, groups, questions"</span>
    </span>
    Structure: first row = header, then title,description per row
  </small>
  </label>

  <button id="run" disabled>Import</button>

  <progress id="prog" value="0" max="100" hidden></progress>

  <pre id="log"></pre>
</div>

<!-- Page 2: Manage Tasks -->
<div id="page-manage" class="page">
  <h2>Manage Project Tasks</h2>
  
  <div>
    <label>Selected project:</label>
    <select id="manageProjectSelect" disabled>
      <option value="">-- Select a project --</option>
    </select>
    <button type="button" id="loadManageProjects" disabled>Enter token first</button>
    <button type="button" id="loadTasks" disabled>Load tasks</button>
  </div>

  <div id="bulk-actions" class="bulk-actions" style="display:none;">
    <div><strong>Selected tasks:</strong> <span id="selectedCount">0</span></div>
    <button type="button" id="selectAll">Select all</button>
    <button type="button" id="deselectAll">Deselect all</button>
    <button type="button" id="deleteSelected" class="danger-btn">üóëÔ∏è Delete selected</button>
  </div>

  <div id="tasksContainer"></div>
  
  <pre id="manageLog"></pre>
</div>

<script>
let viewerLogin=null; // filled when loading projects
let currentTasks = []; // loaded tasks
let selectedTasks = new Set(); // selected task IDs

function log(msg, isManagePage = false){
  const el = document.getElementById(isManagePage ? 'manageLog' : 'log');
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

function showPage(pageId) {
  // Hide all pages
  document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
  
  // Show selected page
  document.getElementById(`page-${pageId}`).classList.add('active');
  event.target.classList.add('active');
}

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const rows = [];
  let currentRow = [];
  let currentField = '';
  let insideQuotes = false;
  let i = 0;
  
  // Skip header row
  while (i < lines.length) {
    const line = lines[i];
    let j = 0;
    
    while (j < line.length) {
      const char = line[j];
      
      if (char === '"' && !insideQuotes) {
        // Start of quoted field
        insideQuotes = true;
      } else if (char === '"' && insideQuotes) {
        // Check if it's escaped quote ("")
        if (j + 1 < line.length && line[j + 1] === '"') {
          currentField += '"';
          j++; // Skip next quote
        } else {
          // End of quoted field
          insideQuotes = false;
        }
      } else if (char === ',' && !insideQuotes) {
        // Field separator
        currentRow.push(currentField.trim());
        currentField = '';
      } else {
        currentField += char;
      }
      j++;
    }
    
    // End of line
    if (insideQuotes) {
      // Multi-line field, add line break and continue
      currentField += '\n';
    } else {
      // End of row
      currentRow.push(currentField.trim());
      if (currentRow.length > 0 && currentRow[0] !== 'title') { // Skip header
        rows.push({
          title: currentRow[0] || '',
          body: currentRow[1] || ''
        });
      }
      currentRow = [];
      currentField = '';
    }
    
    i++;
  }
  
  // Handle last row if needed
  if (currentRow.length > 0) {
    rows.push({
      title: currentRow[0] || '',
      body: currentRow[1] || ''
    });
  }
  
  return rows.filter(row => row.title.trim() !== '');
}

async function ghGraphQL(token, query, variables={}){
  const res=await fetch('https://api.github.com/graphql',{
    method:'POST',
    headers:{
      'Authorization':`Bearer ${token}`,
      'Content-Type':'application/json',
      'Accept':'application/vnd.github+json'
    },
    body:JSON.stringify({query,variables})
  });
  const json=await res.json();
  if(!res.ok || json.errors){
    const msg=json.errors?json.errors.map(e=>e.message).join('; '):await res.text();
    throw new Error(msg);
  }
  return json.data;
}

async function loadProjects(isManagePage = false){
  const token=document.getElementById('token').value.trim();
  const owner=document.getElementById('owner').value.trim();
  if(!token){alert('Enter the token before loading projects');return;}
  
  const btn=document.getElementById(isManagePage ? 'loadManageProjects' : 'loadProjects');
  const select=document.getElementById(isManagePage ? 'manageProjectSelect' : 'projectSelect');
  
  btn.disabled=true; btn.textContent='Loading‚Ä¶';
  select.disabled=true;
  log('Getting Projects list‚Ä¶', isManagePage);
  
  let query, variables={};
  if(owner){
    query=`query($login:String!){
      viewer{login projectsV2(first:50){nodes{id title number}}}
      user(login:$login){projectsV2(first:50){nodes{id title number}}}
      organization(login:$login){projectsV2(first:50){nodes{id title number}}}
    }`;
    variables={login:owner};
  }else{
    query=`query{ viewer{login projectsV2(first:50){nodes{id title number}}} }`;
  }
  
  try{
    const data=await ghGraphQL(token, query, variables);
    viewerLogin=data.viewer.login;
    const nodes=[...(data.viewer.projectsV2.nodes||[])];
    if(owner){
      nodes.push(...(data.user?.projectsV2.nodes||[]));
      nodes.push(...(data.organization?.projectsV2.nodes||[]));
    }
    
    select.innerHTML='';
    if(nodes.length===0){
      select.disabled=true;
      select.innerHTML='<option value="">-- No accessible projects --</option>';
      log('No accessible Projects V2 found with this token/owner.', isManagePage);
    }else{
      nodes.forEach(n=>{
        const opt=document.createElement('option');
        opt.value=n.id;
        opt.textContent=`#${n.number} ‚Äî ${n.title}`;
        select.appendChild(opt);
      });
      select.disabled=false;
      log(`Projects loaded: ${nodes.length} (viewer: ${viewerLogin})`, isManagePage);
      
      // Enable "Load tasks" button on management page
      if(isManagePage) {
        document.getElementById('loadTasks').disabled = false;
      }
    }
  }catch(e){
    log('Error loading projects: '+e.message, isManagePage);
  }
  btn.disabled=false; btn.textContent='Load projects';
}

async function loadTasks() {
  const token = document.getElementById('token').value.trim();
  const projectId = document.getElementById('manageProjectSelect').value;
  
  if (!token || !projectId) {
    alert('Select a project first');
    return;
  }
  
  const btn = document.getElementById('loadTasks');
  btn.disabled = true;
  btn.textContent = 'Loading...';
  
  log('Loading project tasks...', true);
  
  try {
    const query = `query($projectId: ID!) {
      node(id: $projectId) {
        ... on ProjectV2 {
          title
          items(first: 100) {
            nodes {
              id
              content {
                ... on Issue {
                  id
                  number
                  title
                  body
                  url
                  state
                  createdAt
                }
              }
            }
          }
        }
      }
    }`;
    
    const data = await ghGraphQL(token, query, { projectId });
    const project = data.node;
    const items = project.items.nodes.filter(item => item.content && item.content.title);
    
    currentTasks = items;
    selectedTasks.clear();
    
    renderTasks(items);
    log(`Loaded ${items.length} tasks from project "${project.title}"`, true);
    
  } catch (e) {
    log('Error loading tasks: ' + e.message, true);
  }
  
  btn.disabled = false;
  btn.textContent = 'Load tasks';
}

function renderTasks(tasks) {
  const container = document.getElementById('tasksContainer');
  const bulkActions = document.getElementById('bulk-actions');
  
  if (tasks.length === 0) {
    container.innerHTML = '<p>No tasks in this project.</p>';
    bulkActions.style.display = 'none';
    return;
  }
  
  bulkActions.style.display = 'block';
  updateSelectedCount();
  
  container.innerHTML = tasks.map(task => {
    const issue = task.content;
    const isSelected = selectedTasks.has(task.id);
    
    return `
      <div class="task-item ${isSelected ? 'selected' : ''}" data-task-id="${task.id}">
        <div class="checkbox-container">
          <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTaskSelection('${task.id}')">
          <div style="flex: 1;">
            <div class="task-title">#${issue.number} ${issue.title}</div>
            <div class="task-body">${issue.body ? issue.body.substring(0, 200) + (issue.body.length > 200 ? '...' : '') : ''}</div>
            <div class="task-meta">
              State: ${issue.state} | Created: ${new Date(issue.createdAt).toLocaleDateString()}
              <a href="${issue.url}" target="_blank">View on GitHub</a>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function toggleTaskSelection(taskId) {
  if (selectedTasks.has(taskId)) {
    selectedTasks.delete(taskId);
  } else {
    selectedTasks.add(taskId);
  }
  
  const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
  taskElement.classList.toggle('selected', selectedTasks.has(taskId));
  
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = selectedTasks.size;
}

function selectAllTasks() {
  currentTasks.forEach(task => selectedTasks.add(task.id));
  renderTasks(currentTasks);
}

function deselectAllTasks() {
  selectedTasks.clear();
  renderTasks(currentTasks);
}

async function deleteSelectedTasks() {
  if (selectedTasks.size === 0) {
    alert('No tasks selected');
    return;
  }
  
  if (!confirm(`Are you sure you want to delete ${selectedTasks.size} task(s)?`)) {
    return;
  }
  
  const token = document.getElementById('token').value.trim();
  const btn = document.getElementById('deleteSelected');
  btn.disabled = true;
  btn.textContent = 'Deleting...';
  
  let deleted = 0;
  let errors = 0;
  
  for (const taskId of selectedTasks) {
    try {
      const task = currentTasks.find(t => t.id === taskId);
      const issueId = task.content.id;
      
      // First remove from project
      const removeQuery = `mutation($projectId: ID!, $itemId: ID!) {
        deleteProjectV2Item(input: { projectId: $projectId, itemId: $itemId }) {
          deletedItemId
        }
      }`;
      
      const projectId = document.getElementById('manageProjectSelect').value;
      await ghGraphQL(token, removeQuery, { projectId, itemId: taskId });
      
      log(`‚úì Task #${task.content.number} removed from project`, true);
      deleted++;
      
    } catch (e) {
      log(`‚úó Error deleting task: ${e.message}`, true);
      errors++;
    }
  }
  
  log(`Process completed: ${deleted} deleted, ${errors} errors`, true);
  
  // Reload tasks
  selectedTasks.clear();
  await loadTasks();
  
  btn.disabled = false;
  btn.textContent = 'üóëÔ∏è Delete selected';
}

async function createIssue(token,owner,repo,row){
  const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/issues`,{
    method:'POST',
    headers:{'Authorization':`Bearer ${token}`,'Accept':'application/vnd.github+json'},
    body:JSON.stringify({title:row.title, body:row.body})
  });
  if(!res.ok){
    const err=await res.text();
    throw new Error(err);
  }
  return (await res.json()).node_id;
}

async function addToProject(token,projectId,contentId){
  const mutation=`mutation($project:ID!,$content:ID!){ addProjectV2ItemById(input:{projectId:$project,contentId:$content}){ item{id} } }`;
  await ghGraphQL(token, mutation,{project:projectId, content:contentId});
}

async function loadRepos() {
  const token = document.getElementById('token').value.trim();
  const owner = document.getElementById('owner').value.trim() || viewerLogin;
  
  if (!token) {
    alert('Enter the token first');
    return;
  }
  
  if (!owner) {
    alert('Specify the owner or load projects first to get your username');
    return;
  }
  
  const btn = document.getElementById('loadRepos');
  const select = document.getElementById('repo');
  
  btn.disabled = true;
  btn.textContent = 'Loading...';
  select.disabled = true;
  
  log('Loading repositories for ' + owner + '...');
  
  try {
    // Try as user first
    let query = `query($owner: String!) {
      user(login: $owner) {
        repositories(first: 50, orderBy: {field: UPDATED_AT, direction: DESC}) {
          nodes {
            name
            owner {
              login
            }
            isPrivate
            hasIssuesEnabled
            updatedAt
            description
          }
        }
      }
    }`;
    
    let data;
    try {
      data = await ghGraphQL(token, query, { owner });
      if (!data.user) throw new Error('Not a user');
    } catch (userError) {
      // Try as organization
      query = `query($owner: String!) {
        organization(login: $owner) {
          repositories(first: 50, orderBy: {field: UPDATED_AT, direction: DESC}) {
            nodes {
              name
              owner {
                login
              }
              isPrivate
              hasIssuesEnabled
              updatedAt
              description
            }
          }
        }
      }`;
      
      data = await ghGraphQL(token, query, { owner });
      if (!data.organization) {
        throw new Error('User/organization not found');
      }
    }
    
    const repos = data.user?.repositories?.nodes || data.organization?.repositories?.nodes || [];
    
    // Filter only repos with issues enabled
    const reposWithIssues = repos.filter(repo => repo.hasIssuesEnabled);
    
    select.innerHTML = '';
    if (reposWithIssues.length === 0) {
      select.innerHTML = '<option value="">-- No repositories with issues --</option>';
      log('No repositories with issues enabled found.');
    } else {
      reposWithIssues.forEach(repo => {
        const option = document.createElement('option');
        option.value = repo.name;
        option.textContent = `${repo.name}${repo.isPrivate ? ' üîí' : ' üåê'} - ${repo.description || 'No description'}`;
        select.appendChild(option);
      });
      select.disabled = false;
      log(`Repositories loaded: ${reposWithIssues.length} (with issues enabled)`);
    }
    
  } catch (e) {
    log('Error loading repositories: ' + e.message);
    select.innerHTML = '<option value="">-- Error loading --</option>';
  }
  
  btn.disabled = false;
  btn.textContent = 'Load repositories';
}

// Event Listeners
document.getElementById('loadProjects').addEventListener('click', () => loadProjects(false));
document.getElementById('loadManageProjects').addEventListener('click', () => loadProjects(true));
document.getElementById('loadTasks').addEventListener('click', loadTasks);
document.getElementById('selectAll').addEventListener('click', selectAllTasks);
document.getElementById('deselectAll').addEventListener('click', deselectAllTasks);
document.getElementById('deleteSelected').addEventListener('click', deleteSelectedTasks);
document.getElementById('loadRepos').addEventListener('click', loadRepos);

// Token validation - enable/disable buttons based on token presence
document.getElementById('token').addEventListener('input', function() {
  const hasToken = this.value.trim().length > 0;
  
  // Enable/disable import button
  document.getElementById('run').disabled = !hasToken;
  
  // Enable/disable load buttons
  document.getElementById('loadProjects').disabled = !hasToken;
  document.getElementById('loadManageProjects').disabled = !hasToken;
  document.getElementById('loadRepos').disabled = !hasToken;
  
  // Update button text to indicate token requirement
  if (!hasToken) {
    document.getElementById('loadProjects').textContent = 'Enter token first';
    document.getElementById('loadManageProjects').textContent = 'Enter token first';
    document.getElementById('loadRepos').textContent = 'Enter token first';
  } else {
    document.getElementById('loadProjects').textContent = 'Load projects';
    document.getElementById('loadManageProjects').textContent = 'Load projects';
    document.getElementById('loadRepos').textContent = 'Load repositories';
  }
});

document.getElementById('run').addEventListener('click',async ()=>{
  const token=document.getElementById('token').value.trim();
  const ownerInput=document.getElementById('owner').value.trim();
  const ownerName=ownerInput||viewerLogin;
  const repo=document.getElementById('repo').value.trim();
  const projectId=document.getElementById('projectSelect').value;
  const file=document.getElementById('file').files[0];
  if(!token||!repo||!projectId||!file||!ownerName){alert('Missing data or owner not recognized');return;}
  const prog=document.getElementById('prog');
  prog.hidden=false; prog.value=0;
  document.getElementById('log').textContent='';

  const text=await file.text();
  const rows=parseCSV(text);
  const total=rows.length;
  log(`Rows found: ${total}\n---`);
  let done=0;
  for(const row of rows){
    try{
      log(`Creating issue: "${row.title}"‚Ä¶`);
      const nodeId=await createIssue(token,ownerName,repo,row);
      log('   ‚úì Issue created, adding to Project‚Ä¶');
      await addToProject(token,projectId,nodeId);
      log('   ‚úì Added');
    }catch(e){
      log('   ‚úó Error: '+e.message);
    }
    done++; prog.value=Math.round((done/total)*100);
  }
  log('---\nProcess completed.');
});
</script>
</body>
</html>
